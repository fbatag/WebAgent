<!docType html>
<html>

<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAgent</title>

    <!-- Widget JavaScript bundle -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js";
    </script>

    <!-- script src="https://cloud.google.com/ai/gen-app-builder/client?hl=pt-BR"></script -->

    <!-- Search widget element is not visible by default -->
    <!-- gen-search-widget configId="3ed46650-16b3-4aa6-9234-1a2d737b3b1c" triggerId="searchWidgetTrigger" authToken="{{ jwt_token }}"-->
    <!--gen-search-widget configId="d47b7c6b-e5b1-4b75-b4ee-99981b49cc31" triggerId="searchWidgetTrigger">
    </gen-search-widget-->
    <!--input type="hidden" id="jwt_token" name="jwt_token" value="{{ jwt_token }}"-->
</head>

<body>
    <form id="index_form" action="/" method="POST" enctype="multipart/form-data">
        <b style="float: right; text-align: right;">{{ user_version_info }}</b>
        </br></br>
        <!-- Element that opens the widget on click. It does not have to be an fileInputElement -->
        <!--div class="form-box">
            <fileInputElement placeholder="Mundo real" id="searchWidgetTrigger" />
        </div-->
        </br></br>
        <div class="form-box">
            <input type="file" id="audioFile" accept="audio/*">
            <button type="button" id="callAnamneasyButton">Anamneasy Audio</button>
            <button type="button" id="callAnamneasyTeleButton">Anamneasy-tele Audio</button>
        </div>
        <div class="form-box">
            <h3>API Result</h3>
            <pre id="anamneasyResult" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
        </div>
        </br></br>
        <div class="form-box">
            <button type="button" id="loadImageFileButton">Carregar Imagem/PDF</button>
            <button type="button" id="loadImageFolderButton">Carregar pasta</button>
            <button type="button" id="processAllFilesButton" style="display: none;">Lê todos</button>
            <span id="doc-type-all-container" style="display: none;">
                &ensp;&ensp;
                <input type="text" id="doc-type-all" style="width: 40px;">
                <button type="button" id="set-doc-type-all-button">Aplica a todos</button>
            </span>
        </div>
        <div id="master-checkbox-container" style="display: none;">
            <input type="checkbox" id="masterShowErrorCheckbox" checked>
            <label for="masterShowErrorCheckbox">Mostrar todos logs</label>
        </div>
        <div id="image-container"></div>
    </form>

    <script>
        const token = "{{ token }}";
        const anamneasy_api = "{{ anamneasy_api }}";
        const anamneasy_tele_api = "{{ anamneasy_tele_api }}";
        const document_api = "{{ document_api }}";

        //const form = document.querySelector("form");

        const audioFileInput = document.getElementById("audioFile");
        const apiAnamneasyResultElement = document.getElementById("anamneasyResult");

        audioFileInput.addEventListener("change", function () {
            const file = this.files[0];
            if (file)
                apiAnamneasyResultElement.textContent = "";
        });

        function setButtonsState(disabled) {
            document.getElementById("callAnamneasyButton").disabled = disabled;
            document.getElementById("callAnamneasyTeleButton").disabled = disabled;
        }
        document.getElementById("callAnamneasyButton").addEventListener("click", function () {
            sendFileWithButtonDisabling(anamneasy_api);
        });
        document.getElementById("callAnamneasyTeleButton").addEventListener("click", function () {
            sendFileWithButtonDisabling(anamneasy_tele_api);
        });
        async function sendFileWithButtonDisabling(api) {
            const file = audioFileInput.files[0];
            if (!file) {
                alert("Please select a file first.");
                return null;
            }
            setButtonsState(api, true, sendButton);
            apiAnamneasyResultElement.textContent = "Processsando....por favor, espere.";
            try {
                const result = await sendFile(api, file);
                apiAnamneasyResultElement.textContent = result;
            } catch (error) {
                alert("not good call from here: " + error)
            }
            setButtonsState(api, false, sendButton);
        }

        const SendingType = {
            FILE: 'File',
            BINARY: 'Binary'
        };

        const imageContainer = document.getElementById('image-container');
        const fileInputElement = document.createElement('input');
        fileInputElement.type = 'file';

        const loadImageFileButton = document.getElementById("loadImageFileButton");
        const loadImageFolderButton = document.getElementById("loadImageFolderButton");
        const processAllFilesButton = document.getElementById("processAllFilesButton");
        loadImageFileButton.addEventListener("click", function () {
            fileInputElement.webkitdirectory = false;
            fileInputElement.click();
        });

        loadImageFolderButton.addEventListener("click", async function () {
            fileInputElement.webkitdirectory = true;
            fileInputElement.click();
        });

        fileInputElement.onchange = async e => {
            const files = e.target.files;
            //imageContainer.innerHTML = ''; // Clear previous results - for now, accumulating. Delete button can be used or reload the page
            for (const file of files) {
                if (file.type.startsWith('image/') || file.type === 'application/pdf') {
                    loadFile(file)
                }
            }
        };

        function getField(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                return data.list[0].guideType;
            } catch (error) {
                console.error("Erro ao analisar a string JSON:", error);
            }
            return "none";
        }

        async function processFile(file, fileDivElement, sendButton, deleteButton, docTypeText, apiResultElement, docLogElement, errorLogElement, repeatsElem, intervalElem) {
            if (sendButton.textContent == "Pare") {
                sendButton.style.backgroundColor = ""; // Reset color
                sendButton.disabled = true;
                return;
            }
            errorLogElement.textContent = "";
            apiResultElement.textContent = "";
            docLogElement.textContent = "";
            const repeats = parseInt(repeatsElem.value, 10) || 1;
            deleteButton.disabled = true;
            repeatsElem.disabled = true;
            processAllFilesButton.disabled = true;
            loadImageFolderButton.disabled = true;
            loadImageFileButton.disabled = true;
            if (repeats == 1) sendButton.disabled = true;
            else {
                sendButton.textContent = "Pare";
                sendButton.style.backgroundColor = "red";
            }
            let ilegiveis = 0
            for (let i = 0; i < repeats; i++) {
                const docType = 
                console.log(`File: ${file.name}, Repeat: ${i + 1}/${repeats}`);

                apiResultElement.textContent = `Processsando ${i + 1}/${repeats} por favor, espere.....`;
                try {
                    const result = await sendFile(document_api, file, docTypeText.value);
                    apiResultElement.textContent = `Resp.: ${i + 1}/${repeats}\n` + result;
                    const guideType = getField(result);
                    if (guideType != "sadt" && guideType != "outro") {
                        ilegiveis++;
                        docLogElement.textContent += `Repet.: ${i + 1}/${repeats}: ${guideType} - ilegiveis: ${ilegiveis}\n`;
                    }
                }
                catch (error) {
                    errorLogElement.textContent += `Repet.: ${i + 1}/${repeats}: ${error}\n`;
                    apiResultElement.textContent = "";
                }
                var interval = (parseInt(intervalElem.value, 10) || 0) * 1000;
                console.log(`File: ${file.name}, Repeat: ${i + 1}/${repeats} Interval: ${interval}s`);
                if (i < repeats && !sendButton.disabled && interval > 0) {
                    await new Promise(resolve => setTimeout(resolve, interval));
                }
                //apiResultElement.textContent = `${guideType}\nRepet.: ${i + 1}/${repeats}\n${apiResultElement.textContent}`;
                if (sendButton.disabled) break;
            }
            deleteButton.disabled = false;
            sendButton.textContent = "Lê guia";
            sendButton.style.backgroundColor = ""; // Reset color
            sendButton.disabled = false;
            repeatsElem.disabled = false;
            processAllFilesButton.disabled = false;
            loadImageFolderButton.disabled = false;
            loadImageFileButton.disabled = false;
        }

        function updateDynamicElementsVisibility() {
            const fileDivElements = document.querySelectorAll('.image-and-result-visualization');
            const hasFiles = fileDivElements.length > 0;
            processAllFilesButton.style.display = hasFiles ? 'inline-block' : 'none';
            document.getElementById('master-checkbox-container').style.display = hasFiles ? 'block' : 'none';
            document.getElementById('doc-type-all-container').style.display = hasFiles ? 'inline-block' : 'none';
        }

        function loadFile(file) {
            const fileDivElement = createFileDivElement(file);
            imageContainer.appendChild(fileDivElement);
            updateDynamicElementsVisibility();
            showImageFile(fileDivElement, file);
            const errorDiv = fileDivElement.querySelector('.error-div');
            const sendButton = fileDivElement.querySelector('.send-file-button');
            const deleteButton = fileDivElement.querySelector('.delete-element-button');
            sendButton.addEventListener('click', () => processFile(
                file, fileDivElement, sendButton, deleteButton, 
                fileDivElement.querySelector('.doc-type'),
                fileDivElement.querySelector('.api-result'),
                fileDivElement.querySelector('.doc-log'),
                fileDivElement.querySelector('.error-log'),
                fileDivElement.querySelector('.repeats'),
                fileDivElement.querySelector('.interval')));
            deleteButton.addEventListener('click', () => {
                fileDivElement.remove();
                updateDynamicElementsVisibility();
            });
            const showErrorCheckbox = fileDivElement.querySelector('.showErrorCheckbox');
            showErrorCheckbox.addEventListener('change', () => {
                errorDiv.style.display = showErrorCheckbox.checked ? 'block' : 'none';
            });
        }

        function createFileDivElement(file) {
            const fileDivElement = document.createElement('div');
            fileDivElement.className = 'image-and-result-visualization';
            var filename = file.name;
            if (fileInputElement.webkitdirectory)
                filename = file.webkitRelativePath;
            fileDivElement.innerHTML = `
                                <div style="flex: 1; overflow-x: auto;">
                                    <h3>${filename}</h3>
                                    <label for="doc-type-${filename}">Tipo Doc.:</label>
                                    <input type="text" class="doc-type" id="doc-type-${filename}" name="doc-type-${filename}" style="width: 40px;>&ensp;&ensp;
                                    <label for="repeats-${filename}">Repetições:</label>
                                    <input type="number" class="repeats" id="repeats-${filename}" value="1" min="1" style="width: 40px;">&ensp;
                                    <label for="interval-${filename}">Intervalo:</label>
                                    <input type="number" class="interval" id="interval-${filename}" value="0" min="0" style="width: 40px;">&ensp;
                                    <input type="checkbox" class="showErrorCheckbox" checked>
                                    <label for="showErrorCheckbox">Show Error Log</label></br></br>
                                    <button type="button" class="send-file-button">Lê guia</button>&ensp;
                                    <button type="button" class="delete-element-button">Deleta</button></br></br>
                                    <img style="max-width: 100%; height: auto;" alt="${file.name}">
                                </div>
                                <div style="flex: 1; overflow-x: auto;">
                                    <h3>API Result</h3>
                                    <pre class="api-result" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
                                </div>
                                <div class="error-div" style="flex: 1; overflow-x: auto;">
                                    <h3>Log docs ilegiveis</h3>
                                    <pre class="doc-log" style="white-space: pre-wrap; word-wrap: break-word;"></pre></br>
                                    <h3>Log erros:</h3>
                                    <pre class="error-log" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
                                </div>
                            `;
            return fileDivElement;
        }

        function showImageFile(fileDivElement, file) {
            const imgElement = fileDivElement.querySelector('img');
            if (file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = async function (event) {
                    const pdfData = new Uint8Array(event.target.result);
                    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    imgElement.src = canvas.toDataURL();
                };
                reader.readAsArrayBuffer(file);
            } else {
                imgElement.src = URL.createObjectURL(file);
            }
        }

        async function sendFile(api, file, docType, sendingType = SendingType.FILE) {
            // Disable buttons to prevent multiple submissions while processing            
            console.log("File ", file.name, " type: ", file.type, " size: ", file.size);
            const formData = new FormData();
            formData.append("doc-type", docType);
            if (sendingType === SendingType.FILE) {
                formData.append(file.name, file);
                return await callApi(api, formData);
            } else {
                const reader = new FileReader();
                reader.onloadend = async () => {
                    // reader.result contains the file content
                    //console.log('File contet size:', reader.result.length ? reader.result.length : reader.result.byteLength);
                    //console.log('File as data:', reader.result);
                    if (sendingType === SendingType.BINARY) {
                        const blob = new Blob([reader.result], { type: "application/octet-stream" });
                        formData.append(file.name, blob);
                    }
                    return await callApi(api, formData);
                }
                reader.onerror = (error) => {
                    errorText = 'Error reading file:' + error;
                    console.error(errorText);
                    // Re-enable buttons on file read error, as the API call won't be made.
                    throw errorText;
                };
                if (sendingType === SendingType.BINARY) {
                    //formData.append("datatype", SendingType.BINARY);
                    reader.readAsArrayBuffer(file);
                }
            }
        }

        async function callApi(api, formData) {
            console.log(`Calling API ${api}`);
            const response = await fetch(api, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`
                },
                body: formData,
            });
            if (response.ok) {
                console.log("Response ok");
                return await response.text();
            } else {
                console.log("Response error");
                const serverError = await response.text();
                const errorText = `API response error: ${response.status} - ${serverError}`
                throw errorText;
            }
        }

        document.getElementById("processAllFilesButton").addEventListener("click", async function () {
            const fileDivElements = document.querySelectorAll('.image-and-result-visualization');
            for (const fileDivElement of fileDivElements) {
                const sendButton = fileDivElement.querySelector('.send-file-button');
                sendButton.click();
            }
        });

        document.getElementById("set-doc-type-all-button").addEventListener("click", function () {
            const allDocType = document.getElementById("doc-type-all").value;
            const docTypeInputs = document.querySelectorAll('.doc-type');
            docTypeInputs.forEach(input => {
                input.value = allDocType;
            });
        });

        document.getElementById('masterShowErrorCheckbox').addEventListener('change', function() {
            const isChecked = this.checked;
            const allCheckboxes = document.querySelectorAll('.showErrorCheckbox');
            allCheckboxes.forEach(checkbox => {
                if (checkbox.checked !== isChecked) {
                    checkbox.checked = isChecked;
                    // Manually trigger the change event for each checkbox
                    const event = new Event('change');
                    checkbox.dispatchEvent(event);
                }
            });
        });

        // Ask the authorization token for the application
        // Set authorization token.
        //const jwt_token = document.getElementById("jwt_token").value;
        //const searchWidget = document.querySelector('gen-search-widget');
        //searchWidget.authToken = jwt_token;    
    </script>
</body>

</html>
